{% extends "base.html" %}

{% block title %}Dashboard - DDoS Detection{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
    <!-- Stats Cards -->
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-indigo-100 text-indigo-600">
                <i class="mdi mdi-chart-line mdi-24px"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Total Traffic</h3>
                <p id="total-traffic" class="text-2xl font-semibold">0</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-red-100 text-red-600">
                <i class="mdi mdi-shield-alert mdi-24px"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Active Threats</h3>
                <p id="active-threats" class="text-2xl font-semibold">0</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                <i class="mdi mdi-shield-lock mdi-24px"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Blocked IPs</h3>
                <p id="blocked-ips" class="text-2xl font-semibold">0</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                <i class="mdi mdi-account-network mdi-24px"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Active Connections</h3>
                <p id="active-connections" class="text-2xl font-semibold">0</p>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex items-center">
            <div class="p-3 rounded-full bg-green-100 text-green-600">
                <i class="mdi mdi-shield-check mdi-24px"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-gray-500 text-sm font-medium">Monitoring Status</h3>
                <p id="monitoring-status" class="text-lg font-semibold text-green-600">Active</p>
            </div>
        </div>
    </div>
</div>


<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Traffic Chart -->
    <div class="bg-white rounded-lg shadow p-6 lg:col-span-2">
        <h3 class="text-lg font-medium mb-4">Network Traffic</h3>
        <div class="h-80">
            <canvas id="trafficChart"></canvas>
        </div>
    </div>

    <!-- Recent Alerts -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h3 class="text-lg font-medium">Recent Alerts</h3>
        </div>
        <div id="recent-alerts" class="divide-y divide-gray-200 max-h-96 overflow-y-auto">
            <!-- Alerts will be inserted here -->
            <div class="p-4 text-center text-gray-500">
                No recent alerts
            </div>
        </div>
    </div>
</div>

<!-- Top IPs Table -->
<div class="bg-white rounded-lg shadow overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-medium">Active Connections</h3>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <span id="active-connections-table">0</span> active connections
                    </div>
                    <button id="clear-traffic-btn" onclick="clearTraffic()" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded text-sm">
                        Clear Traffic
                    </button>
                    <button id="refresh-btn" onclick="refreshData()" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded text-sm">
                        Refresh Data
                    </button>
                    <button id="status-btn" onclick="checkStatus()" class="bg-purple-500 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded text-sm">
                        Check Status
                    </button>
                    <button id="system-info-btn" onclick="showSystemInfo()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded text-sm">
                        System Info
                    </button>
                    <button id="help-btn" onclick="showHelp()" class="bg-teal-500 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded text-sm">
                        Help
                    </button>
                </div>
            </div>
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requests</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate (req/s)</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Seen</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody id="connections-table" class="bg-white divide-y divide-gray-200">
                <!-- Rows will be inserted here -->
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">No active connections</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables
const connections = new Map();
const trafficData = [];
const MAX_DATA_POINTS = 30;
let trafficChart = null;
let alertCount = 0; // Track number of alerts

// Initialize charts
function initializeCharts() {
    const trafficCtx = document.getElementById('trafficChart');
    if (!trafficCtx) return;
    
    const config = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Requests per second',
                data: [],
                borderColor: 'rgba(79, 70, 229, 1)',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 300 },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { display: true, drawBorder: false },
                    ticks: { 
                        precision: 1,
                        stepSize: 0.1,
                        callback: function(value) {
                            return value.toFixed(1) + ' req/s';
                        }
                    },
                    min: 0,
                    suggestedMax: 1
                },
                x: {
                    grid: { display: false, drawBorder: false }
                }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    mode: 'index',
                    intersect: false
                }
            },
            elements: { point: { radius: 0 } },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            }
        }
    };
    
    trafficChart = new Chart(trafficCtx.getContext('2d'), config);
}

// Handle traffic updates from the base template
window.handleTrafficUpdate = function(data) {
    try {
        console.log('Received traffic update:', data);
        if (!data || !data.ip) {
            console.warn('Invalid traffic update data:', data);
            return;
        }
        updateTrafficChart(data);
        updateConnectionsTable(data);
    } catch (e) {
        console.error('Error handling traffic update:', e);
    }
};

// Handle system stats updates
window.handleSystemStats = function(data) {
    try {
        console.log('Received system stats:', data);
        if (!data) {
            console.warn('Received empty system stats data');
            return;
        }
        console.log('Updating stats with data:', data);
        
        // Update the stats card with server data if available, otherwise use client data
        const serverConnections = typeof data.active_connections !== 'undefined' ? data.active_connections : connections.size;
        
        // Update both the stats card and table header with the same value
        const statsCardElement = document.getElementById('active-connections');
        const tableHeaderCount = document.getElementById('active-connections-table');
        
        if (statsCardElement) {
            statsCardElement.textContent = serverConnections;
        }
        if (tableHeaderCount) {
            tableHeaderCount.textContent = serverConnections;
        }
        
        // Update other stats
        updateStats(data);
        
        console.log(`Updated both displays with ${serverConnections} active connections`);
    } catch (e) {
        console.error('Error handling system stats:', e);
    }
};

// Update traffic chart with new data
function updateTrafficChart(data) {
    if (!trafficChart) {
        console.warn('Chart not initialized, reinitializing...');
        initializeCharts();
        if (!trafficChart) {
            console.error('Failed to initialize chart');
            return;
        }
    }
    
    const now = new Date();
    const timeLabel = now.toLocaleTimeString();
    const requestRate = parseFloat(data.request_rate) || 0;
    
    // Ensure we have a valid rate to display
    if (requestRate === 0 && data.request_count > 0) {
        // Calculate rate if not provided but we have request count
        const calculatedRate = data.request_count / 10; // Assume 10 second window
        console.log(`Calculated rate: ${calculatedRate} from count: ${data.request_count}`);
    }
    
    // Add new data point with proper rate - only if we have actual traffic
    const actualRate = requestRate > 0 ? requestRate : 0;
    const dataPoint = {
        time: timeLabel,
        rate: actualRate, // Use actual rate, don't artificially inflate
        ip: data.ip,
        timestamp: data.timestamp
    };
    
    trafficData.push(dataPoint);
    
    // Keep only the last MAX_DATA_POINTS
    if (trafficData.length > MAX_DATA_POINTS) {
        trafficData.shift();
    }
    
    // Update chart data
    trafficChart.data.labels = trafficData.map(d => d.time);
    trafficChart.data.datasets[0].data = trafficData.map(d => d.rate);
    
    // Force chart update with animation
    trafficChart.update('active');
    
    console.log(`Chart updated: ${data.ip} - ${requestRate} req/s (displayed as ${dataPoint.rate})`);
    console.log(`Chart now has ${trafficData.length} data points:`, trafficData.map(d => d.rate));
    console.log('Chart Y-axis max:', Math.max(...trafficData.map(d => d.rate)));
}

// Update connections table
function updateConnectionsTable(data) {
    if (!data || !data.ip) return;
    
    const now = new Date();
    connections.set(data.ip, {
        requestCount: data.request_count || 0,
        requestRate: (data.request_rate || 0).toFixed(2),
        lastSeen: now.toLocaleTimeString(),
        timestamp: data.timestamp || now.getTime()
    });
    
    console.log(`Updated connections table for ${data.ip}:`, connections.get(data.ip));
    console.log(`Total connections: ${connections.size}`);
    
    // Show notification for new traffic
    showTrafficNotification(data);
    
    renderConnectionsTable();
    
    // Update stats after adding new connection data
    updateStats();
}

// Render the connections table
function renderConnectionsTable() {
    const tbody = document.getElementById('connections-table');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (connections.size === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-gray-500">No active connections</td>
            </tr>`;
        return;
    }
    
    // Convert to array and sort by request count (descending)
    const sortedConnections = Array.from(connections.entries())
        .sort((a, b) => b[1].requestCount - a[1].requestCount);
    
    sortedConnections.forEach(([ip, stats]) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">${ip}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stats.requestCount.toLocaleString()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stats.requestRate}/s</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stats.lastSeen}</td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button onclick="blockIP('${ip}')" class="text-red-600 hover:text-red-900">Block</button>
            </td>`;
        tbody.appendChild(row);
    });
    
    updateActiveConnectionsCount();
}

// Update the active connections count
function updateActiveConnectionsCount() {
    const countElement = document.getElementById('active-connections');
    const tableCountElement = document.getElementById('active-connections-table');
    const currentCount = connections.size;
    
    if (countElement) {
        countElement.textContent = currentCount;
    }
    if (tableCountElement) {
        tableCountElement.textContent = currentCount;
    }
    
    console.log(`Updated both connection displays to: ${currentCount}`);
}

// Initialize connections map if it doesn't exist
if (!window.connections) {
    window.connections = new Map();
}

// Update stats display
function updateStats(stats = {}) {
    try {
        // Calculate total traffic from all connections
        let totalTraffic = 0;
        let totalThreats = 0;
        
        connections.forEach((connStats, ip) => {
            totalTraffic += connStats.requestCount;
            // Simple threat detection based on high request rate
            if (connStats.requestRate > 50) {
                totalThreats++;
            }
        });
        
        // Update display elements
        const totalTrafficElement = document.getElementById('total-traffic');
        const activeThreatsElement = document.getElementById('active-threats');
        const activeConnectionsElement = document.getElementById('active-connections');
        
        if (totalTrafficElement) {
            totalTrafficElement.textContent = totalTraffic.toLocaleString();
        }
        
        if (activeThreatsElement) {
            activeThreatsElement.textContent = totalThreats;
        }
        
        if (activeConnectionsElement) {
            activeConnectionsElement.textContent = connections.size;
        }
        
        // Update blocked IPs if we have the data
        const blockedIpsElement = document.getElementById('blocked-ips');
        if (blockedIpsElement) {
            const blockedCount = typeof stats.blocked_ips !== 'undefined' ? stats.blocked_ips : 0;
            blockedIpsElement.textContent = blockedCount;
            console.log(`Updated blocked IPs display to: ${blockedCount}`);
            
            // Force update if we have server data
            if (typeof stats.blocked_ips !== 'undefined') {
                console.log(`Forced blocked IPs update from server data: ${stats.blocked_ips}`);
            }
        }
        
        // Also update the connections count in the table section
        updateActiveConnectionsCount();
        
        console.log(`Stats updated - Traffic: ${totalTraffic}, Threats: ${totalThreats}, Connections: ${connections.size}`);
        
    } catch (error) {
        console.error('Error updating stats:', error);
    }
}

// Block IP address
function blockIP(ip) {
    if (!ip) return;
    
    fetch(`/api/block-ip/${encodeURIComponent(ip)}`, { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`Successfully blocked IP: ${ip}`);
            // Remove from connections table
            connections.delete(ip);
            renderConnectionsTable();
        } else {
            alert(`Failed to block IP: ${data.message || 'Unknown error'}`);
        }
    })
    .catch(error => {
        console.error('Error blocking IP:', error);
        alert('Error blocking IP. Please check the console for details.');
    });
}



// Clear all traffic data
function clearTraffic() {
    const btn = document.getElementById('clear-traffic-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Clearing...';
    }
    
    showStartingNotification('Clearing old traffic data...');
    
    fetch('/api/clear-traffic', { 
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            console.log('Traffic cleared:', data);
            showSuccessNotification(data.message);
            
            // Don't clear all local data, just refresh it
            if (window.socket && window.socket.connected) {
                window.socket.emit('get_initial_data');
            }
            
            // Update stats to reflect current state
            updateStats();
        } else {
            console.error('Failed to clear traffic:', data.message);
            showFailureNotification('Failed to clear traffic data');
        }
    })
    .catch(error => {
        console.error('Error clearing traffic:', error);
        showFailureNotification('Error clearing traffic data. Check console for details.');
    })
    .finally(() => {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'Clear Traffic';
        }
    });
}


// Show system information
function showSystemInfo() {
    const btn = document.getElementById('system-info-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Loading...';
    }
    
    fetch('/api/system-info')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log('System info:', data.system_info);
                
                // Format system info for display
                const info = data.system_info;
                let infoMessage = `System Information:\n\n`;
                infoMessage += `Platform: ${info.platform} ${info.platform_version}\n`;
                infoMessage += `Machine: ${info.machine}\n`;
                infoMessage += `Processor: ${info.processor}\n`;
                infoMessage += `Python: ${info.python_version}\n`;
                infoMessage += `CPU Cores: ${info.cpu_count}\n`;
                infoMessage += `Memory: ${Math.round(info.memory_available / 1024 / 1024 / 1024 * 100) / 100} GB available of ${Math.round(info.memory_total / 1024 / 1024 / 1024 * 100) / 100} GB\n`;
                infoMessage += `Disk Usage: ${info.disk_usage}%\n`;
                infoMessage += `Network Interfaces: ${info.network_interfaces.join(', ')}`;
                
                alert(infoMessage);
            } else {
                console.error('Failed to get system info:', data.message);
                showFailureNotification('Failed to get system information');
            }
        })
        .catch(error => {
            console.error('Error getting system info:', error);
            showFailureNotification('Error getting system information. Check console for details.');
        })
        .finally(() => {
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'System Info';
            }
        });
}

// Show help information
function showHelp() {
    const helpMessage = `DDoS Detection System - Help

ðŸ“Š Dashboard Features:
â€¢ Real-time traffic monitoring
â€¢ Interactive charts and statistics
â€¢ IP connection management
â€¢ System status indicators

ðŸ”§ Available Actions:
â€¢ Clear Traffic: Removes all current traffic data
â€¢ Refresh Data: Reconnects and gets fresh data
â€¢ Check Status: Shows detailed system health
â€¢ System Info: Displays system specifications
â€¢ Help: Shows this help message

ðŸ’¡ Tips:
â€¢ Run as Administrator for real network monitoring
â€¢ Generate network activity (browse web, download files) to see traffic
â€¢ Check browser console for detailed logs
â€¢ Monitor the status indicators for system health

ðŸ†˜ Troubleshooting:
â€¢ If no traffic appears, generate real network activity
â€¢ For packet capture, run as Administrator on Windows
â€¢ Check the "Check Status" button for system health
â€¢ Refresh the page if issues occur`;
    
    alert(helpMessage);
}

// Refresh data from server
function refreshData() {
    const btn = document.getElementById('refresh-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Refreshing...';
    }
    
    // Request fresh data from server
    if (window.socket && window.socket.connected) {
        window.socket.emit('get_initial_data');
        console.log('Requested fresh data from server');
        showStartingNotification('Refreshing data from server...');
    } else {
        console.warn('Socket not connected, cannot refresh data');
        showFailureNotification('Socket not connected. Please refresh the page.');
    }
    
    // Re-enable button after a short delay
    setTimeout(() => {
        if (btn) {
            btn.disabled = false;
            btn.textContent = 'Refresh Data';
        }
    }, 1000);
}

// Check system status
function checkStatus() {
    const btn = document.getElementById('status-btn');
    if (btn) {
        btn.disabled = true;
        btn.textContent = 'Checking...';
    }
    
    fetch('/status')
        .then(response => response.json())
        .then(data => {
            console.log('System status:', data);
            
            // Update monitoring status display
            updateMonitoringStatus(data);
            
            // Show status in a more user-friendly way
            showStatusNotification(data);
            
            // Show success notification if monitoring is working
            if (data.active_connections > 0 || data.background_threads.sniffing_thread) {
                showSuccessNotification('System status check completed successfully');
            }
        })
        .catch(error => {
            console.error('Error checking status:', error);
            showFailureNotification('Error checking system status. Check console for details.');
        })
        .finally(() => {
            if (btn) {
                btn.disabled = false;
                btn.textContent = 'Check Status';
            }
        });
}

// Update monitoring status display
function updateMonitoringStatus(data) {
    const statusElement = document.getElementById('monitoring-status');
    if (!statusElement) return;
    
    if (data.active_connections > 0) {
        statusElement.textContent = 'Active';
        statusElement.className = 'text-lg font-semibold text-green-600';
    } else if (data.background_threads && data.background_threads.sniffing_thread) {
        statusElement.textContent = 'Monitoring';
        statusElement.className = 'text-lg font-semibold text-blue-600';
    } else {
        statusElement.textContent = 'Inactive';
        statusElement.className = 'text-lg font-semibold text-red-600';
    }
}

// Start monitoring automatically
function startMonitoring() {
    console.log('Real network monitoring is active...');
    
    // Show starting notification
    showStartingNotification('Real network monitoring is active. Generate network activity to see traffic data.');
    
    // Check status after a delay
    setTimeout(() => {
        checkStatus();
    }, 2000);
}

// Show status notification
function showStatusNotification(data) {
    // Create or update status notification
    let notification = document.getElementById('status-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'status-notification';
        notification.className = 'fixed top-4 right-4 w-80 bg-white rounded-lg shadow-lg border-l-4 border-blue-500 z-50';
        document.body.appendChild(notification);
    }
    
    const status = data.active_connections > 0 ? 'Active' : 
                  data.background_threads.sniffing_thread ? 'Monitoring' : 'Inactive';
    
    const statusColor = data.active_connections > 0 ? 'text-green-600' : 
                       data.background_threads.sniffing_thread ? 'text-blue-600' : 'text-red-600';
    
    notification.innerHTML = `
        <div class="p-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900">System Status</h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-500">
                    <i class="mdi mdi-close text-xl"></i>
                </button>
            </div>
            <div class="mt-2 space-y-2">
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500">Status:</span>
                    <span class="text-sm font-medium ${statusColor}">${status}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500">Active Connections:</span>
                    <span class="text-sm font-medium">${data.active_connections}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500">Total Packets:</span>
                    <span class="text-sm font-medium">${data.total_packets}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500">Network Interface:</span>
                    <span class="text-sm font-medium">${data.network_interface}</span>
                </div>
            </div>
        </div>
    `;
    
    // Auto-hide after 10 seconds
    setTimeout(() => {
        if (notification && notification.parentElement) {
            notification.remove();
        }
    }, 10000);
}

// Show failure notification
function showFailureNotification(message) {
    let notification = document.createElement('div');
    notification.className = 'fixed top-4 left-4 w-80 bg-white rounded-lg shadow-lg border-l-4 border-red-500 z-50';
    
    notification.innerHTML = `
        <div class="p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="mdi mdi-alert-circle text-red-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-gray-900">Warning</h3>
                    <p class="text-sm text-gray-500">${message}</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide after 8 seconds
    setTimeout(() => {
        if (notification && notification.parentElement) {
            notification.remove();
        }
    }, 8000);
}

// Show success notification
function showSuccessNotification(message) {
    let notification = document.createElement('div');
    notification.className = 'fixed top-4 left-4 w-80 bg-white rounded-lg shadow-lg border-l-4 border-green-500 z-50';
    
    notification.innerHTML = `
        <div class="p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="mdi mdi-check-circle text-green-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-gray-900">Success!</h3>
                    <p class="text-sm text-gray-500">${message}</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (notification && notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Show starting notification
function showStartingNotification() {
    let notification = document.createElement('div');
    notification.className = 'fixed top-4 left-4 w-80 bg-white rounded-lg shadow-lg border-l-4 border-yellow-500 z-50';
    
    notification.innerHTML = `
        <div class="p-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="mdi mdi-loading mdi-spin text-yellow-500 text-xl"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-lg font-medium text-gray-900">Starting Monitoring</h3>
                    <p class="text-sm text-gray-500">Real network monitoring is active...</p>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        if (notification && notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Show traffic notification
function showTrafficNotification(data) {
    // Create or update traffic notification
    let notification = document.getElementById('traffic-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'traffic-notification';
        notification.className = 'fixed bottom-4 right-4 w-80 bg-white rounded-lg shadow-lg border-l-4 border-green-500 z-50';
        document.body.appendChild(notification);
    }
    
    notification.innerHTML = `
        <div class="p-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-medium text-gray-900">Traffic Detected</h3>
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-500">
                    <i class="mdi mdi-close text-xl"></i>
                </button>
            </div>
            <div class="mt-2 space-y-2">
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500">IP Address:</span>
                    <span class="text-sm font-medium font-mono">${data.ip}</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500">Request Rate:</span>
                    <span class="text-sm font-medium">${data.request_rate || 0} req/s</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-sm text-gray-500">Total Requests:</span>
                    <span class="text-sm font-medium">${data.request_count || 0}</span>
                </div>
            </div>
        </div>
    `;
    
    // Auto-hide after 8 seconds
    setTimeout(() => {
        if (notification && notification.parentElement) {
            notification.remove();
        }
    }, 8000);
}

// Initialize global variables
if (!window.alertCount) {
    window.alertCount = 0;
}
if (!window.connections) {
    window.connections = new Map();
}

// Initialize the page
document.addEventListener('DOMContentLoaded', () => {
    try {
        // Initialize charts
        initializeCharts();
        
        // Initial render
        renderConnectionsTable();
        updateStats();
        
        // Request initial data immediately after chart initialization
        setTimeout(() => {
            if (window.socket && window.socket.connected) {
                window.socket.emit('get_initial_data');
                console.log('Requested initial chart data');
            }
        }, 500);
        
        // Check initial status
        setTimeout(() => {
            checkStatus();
        }, 2000);
        
        // Try to start monitoring automatically
        setTimeout(() => {
            startMonitoring();
        }, 3000);
        
        // Set up periodic status checking
        setInterval(() => {
            checkStatus();
        }, 30000); // Check every 30 seconds
        
        // Set up refresh button if it exists
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                if (window.showStartingNotification) {
                    window.showStartingNotification('Refreshing page...');
                }
                window.location.reload();
            });
        }
        
        console.log('Page initialization complete');
        
        // Show success notification when page is ready
        setTimeout(() => {
            if (window.showSuccessNotification) {
                window.showSuccessNotification('DDoS Detection Dashboard is ready!');
            }
        }, 1000);
    } catch (e) {
        console.error('Error during page initialization:', e);
        
        // Show failure notification if initialization fails
        if (window.showFailureNotification) {
            window.showFailureNotification('Error during page initialization. Check console for details.');
        }
    }
});

// Show notification when page is about to unload
window.addEventListener('beforeunload', () => {
    if (window.showStartingNotification) {
        window.showStartingNotification('Page is being refreshed...');
    }
});
</script>
{% endblock %}
